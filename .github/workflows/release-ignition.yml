name: Release Ignition Configs

on:
    push:
        branches:
            - main
        paths:
            - "butane/**"

permissions:
    contents: write

jobs:
    generate-and-release:
        name: Generate and Release Ignition Configs
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Install butane
              run: |
                  BUTANE_VERSION="v0.25.1"
                  curl -sL "https://github.com/coreos/butane/releases/download/${BUTANE_VERSION}/butane-x86_64-unknown-linux-gnu" -o /usr/local/bin/butane
                  sudo chmod +x /usr/local/bin/butane
                  butane --version

            - name: Validate Butane configs
              run: |
                  echo "Validating Butane configuration files..."
                  echo "Validating butane/node.bu..."
                  butane --strict < butane/node.bu > /dev/null
                  echo "âœ“ butane/node.bu is valid"

            - name: Generate Ignition configs
              run: |
                  mkdir -p ignition-output

                  echo "Generating node.ign..."
                  butane --strict --pretty < butane/node.bu > ignition-output/node.ign

                  echo "Generated Ignition configs:"
                  ls -lh ignition-output/

            - name: Generate checksums
              run: |
                  cd ignition-output
                  sha256sum *.ign > SHA256SUMS
                  cat SHA256SUMS

            - name: Determine version
              id: version
              run: |
                  VERSION="v$(date +%Y%m%d-%H%M%S)"
                  echo "version=${VERSION}" >> $GITHUB_OUTPUT
                  echo "Release version: ${VERSION}"

            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.version.outputs.version }}
                  name: Ignition Configs ${{ steps.version.outputs.version }}
                  body: |
                      ## Fedora CoreOS Ignition Configurations

                      **Generated:** ${{ github.event.head_commit.timestamp }}
                      **Commit:** ${{ github.sha }}

                      ### Files:
                      - `node.ign` - For control plane nodes (3 nodes)
                      - `SHA256SUMS` - Checksums for verification

                      ### Usage:

                      ```bash
                      # Download Ignition config
                      curl -sLO https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/node.ign

                      # Verify checksum
                      curl -sLO https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/SHA256SUMS
                      sha256sum -c SHA256SUMS

                      # Use with coreos-installer
                      coreos-installer install /dev/nvme0n1 \
                        --ignition-file node.ign \
                        --stream stable \
                        --architecture x86_64
                      ```

                      ### Installation:
                      1. Boot Hetzner server into rescue mode
                      2. Wipe disks if needed (e.g., `wipefs /dev/nvme0n1 /dev/nvme1n1`)
                      3. Download Ignition config
                      4. Run coreos-installer
                      5. Reboot

                      ### Changes:
                      ${{ github.event.head_commit.message }}
                  files: |
                      ignition-output/node.ign
                      ignition-output/worker.ign
                      ignition-output/SHA256SUMS
                  draft: false
                  prerelease: false

            - name: Summary
              run: |
                  echo "## Release Created Successfully! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Download URLs:" >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
                  echo "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/node.ign" >> $GITHUB_STEP_SUMMARY
                  echo "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/worker.ign" >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
